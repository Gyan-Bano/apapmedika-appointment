<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Appointment Detail</title>

    <!-- Bootstrap 4.5.2 -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    </head>

  <body>
    <nav th:replace="~{fragments/navbar :: navbar}"></nav>
    <!-- Navbar Fragment -->

    <div class="container mt-4">
      <div class="card">
        <!-- Card Header for Appointment Details and Actions -->
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <div class="d-flex align-items-center">
            <h5 class="mb-0 mr-2">Appointment Detail</h5>
            <span
              class="badge badge-success"
              th:text="${appointment.status}"
            ></span>
          </div>

          <!-- Appointment Actions -->
          <div class="btn-group" role="group" aria-label="Appointment actions">
            <button class="btn btn-success btn-sm rounded mr-2">
              Mark as Done
            </button>
            <a
              class="btn btn-primary btn-sm rounded mr-2"
              th:href="@{/appointment/{id}/update(id=${appointment.id})}"
            >
              Update
            </a>
            <button class="btn btn-warning btn-sm rounded mr-2">Cancel</button>
            <button class="btn btn-danger btn-sm rounded">Delete</button>
          </div>
        </div>

        <!-- Card Body for Appointment Details -->
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p>
                <strong>ID:</strong> <span th:text="${appointment.id}"></span>
              </p>
              <p>
                <strong>Patient:</strong>
                <span th:text="${appointment.patient}"></span>
              </p>
              <p>
                <strong>Doctor:</strong>
                <span th:text="${appointment.doctor}"></span>
              </p>
              <p>
                <strong>Appointment Date:</strong>
                <span th:text="${appointment.date}"></span>
              </p>
              <p>
                <strong>Created At:</strong>
                <span th:text="${appointment.createdAt}"></span>
              </p>
              <p>
                <strong>Last Updated At:</strong>
                <span th:text="${appointment.updatedAt}"></span>
              </p>
            </div>
          </div>

          <hr />

          <!-- Editable Mode -->
          <div th:if="${editable}">
            <form
              th:action="@{/appointment/note}"
              method="post"
              th:object="${UpdateDiagnosisTreatmentRequestDTO}"
            >
              <input type="hidden" th:field="*{id}" />

              <div class="row mb-3">
                <div class="col-md-12">
                  <h5>Diagnosis</h5>
                  <textarea
                    class="form-control"
                    id="diagnosis"
                    rows="3"
                    th:field="*{diagnosis}"
                  ></textarea>
                </div>
              </div>

              <!-- Treatment Rows -->
              <div class="row mb-3">
                <div class="col-md-12">
                  <h5>Treatments</h5>
                  <table class="table" id="treatmentTable">
                    <thead>
                      <tr>
                        <th>Treatment</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr th:each="treatmentId, status : *{treatmentIds}">
                        <td>
                          <select
                            class="form-control"
                            th:field="*{treatmentIds[__${status.index}__]}"
                          >
                            <option value="">Select a treatment</option>
                            <option
                              th:each="availableTreatment : ${treatments}"
                              th:value="${availableTreatment.id}"
                              th:text="${availableTreatment.name}"
                              th:selected="${availableTreatment.id == treatmentId}"
                            ></option>
                          </select>
                        </td>
                        <td>
                          <button
                            class="btn btn-danger btn-sm rounded"
                            type="submit"
                            name="deleteRow"
                            th:value="${status.index}"
                          >
                            Delete
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>

                  <!-- Add Treatment Button -->
                  <button class="btn btn-secondary" type="submit" name="addRow">
                    Add Treatment
                  </button>
                </div>
              </div>

              <!-- Save Button -->
              <div class="row">
                <div class="col-md-12 text-right">
                  <button type="submit" class="btn btn-primary">Save</button>
                </div>
              </div>
            </form>
          </div>

          <!-- View Mode (if not editable) -->
          <div th:unless="${editable}">
            <div class="row mb-3">
              <div class="col-md-12">
                <h5>Diagnosis</h5>
                <p th:text="${appointment.diagnosis ?: 'No records yet.'}"></p>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-12">
                <h5>Treatments</h5>
                <ul
                  th:if="${appointment.treatments != null and not #lists.isEmpty(appointment.treatments)}"
                >
                  <li
                    th:each="treatment : ${appointment.treatments}"
                    th:text="${treatment.name}"
                  ></li>
                </ul>
                <ul
                  th:if="${appointment.treatments != null and not #lists.isEmpty(appointment.treatments)}"
                >
                  <li
                    th:each="treatment : ${appointment.treatments}"
                    th:text="${treatment}"
                  ></li>
                </ul>
                <p
                  th:if="${appointment.treatments == null or #lists.isEmpty(appointment.treatments)}"
                >
                  No treatments yet.
                </p>
              </div>
            </div>

            <!-- Edit Diagnosis & Treatments Button -->
            <div class="row">
              <div class="col-md-12 text-right">
                <a
                  th:href="@{/appointment/{id}/note(id=${appointment.id})}"
                  class="btn btn-primary"
                  >Add/Edit Diagnosis & Treatments</a
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
